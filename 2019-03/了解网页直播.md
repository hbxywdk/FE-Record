## 直播协议
### HLS
HLS 全称是 HTTP Live Streaming。这是 Apple 提出的直播流协议。目前，IOS 和 高版本 Android 都支持 HLS。那什么是 HLS 呢？ HLS 主要的两块内容是 .m3u8 文件和 .ts 播放文件。接受服务器会将接受到的视频流进行缓存，然后缓存到一定程度后，会将这些视频流进行编码格式化，同时会生成一份 .m3u8 文件和其它很多的 .ts 文件。HLS 的基本架构为：
* 服务器：后台服务器接受视频流，然后进行编码和片段化。
* 编码：视频格式编码采用 H.264。音频编码为 AAC, MP3, AC-3，EC-3。然后使用 MPEG-2 Transport Stream 作为容器格式。
* 客户端：使用一个 URL 去下载 m3u8 文件，然后，开始下载 ts 文件，下载完成后，使用 playback software（即时播放器） 进行播放。

masterplaylist：
* live playlist: 动态列表。顾名思义，该列表是动态变化的，里面的 ts 文件会实时更新，并且过期的 ts 索引会被删除。默认，情况下都是使用动态列表。
* event playlist: 静态列表。它和动态列表主要区别就是，原来的 ts 文件索引不会被删除，该列表是不断更新，而且文件大小会逐渐增大。它会在文件中，直接添加 #EXT-X-PLAYLIST-TYPE:EVENT 作为标识。
* VOD playlist: 全量列表。它就是将所有的 ts 文件都列在 list 当中。如果，使用该列表，就和播放一整个视频没有啥区别了。它是使用 #EXT-X-ENDLIST 表示文件结尾。

m3u8文件内容（以下为live playlist，不包含汉字）
```
#EXTM3U                             m3u文件头
#EXT-X-VERSION:3                    PlayList版本
#EXT-X-ALLOW-CACHE:NO               是否允许缓存
#EXT-X-TARGETDURATION:5             分片最大时长，单位秒
#EXT-X-MEDIA-SEQUENCE:1552956728    第一个TS分片的序列号，默认为 0

#EXTINF:3.469,                      指定每个媒体段(ts)的持续时间（秒），仅对其后面的URI有效
http://media.test.com/1552956727.ts
#EXTINF:4.145,
http://media.test.com/1552956728.ts
#EXTINF:4.141,
http://media.test.com/1552956729.ts

```

##### HLS如何完成直播？ 
服务端：将接收到的流每缓存一定时间后包装为一个新的ts文件，然后更新m3u8文件。m3u8文件中只保留最新的几个片段。

客户端：直接使用video标签加载m3u8文件（live playlist），video标签会自动解析其内容进行直播播放。

```
<video src="http://hlsa.xxxxx.com/live/test.m3u8" autoplay controls></video>
```

##### HLS的优点
支持范围广，使用简单，完美适用于H5，是`移动端天生的直播方案`。

##### HLS的缺点
由于 HLS 是基于 HTTP 的，所以其直播延迟较高。带来延迟的主要地方有：
1. TCP 握手
2. m3u8 文件下载
3. m3u8 文件下所有 ts 文件下载

##### HLS的优化方案
减少每个 m3u8 文件中的 ts文件的 数量和时长，但单个ts文件时间变短会增加服务器性能消耗。


### RTMP
RTMP即Real Time Messaging Protocol（实时消息传输协议）的首字母缩写。该协议基于TCP，是一个协议族，包括RTMP基本协议及RTMPT/RTMPS/RTMPE等多种变种。RTMP是一种设计用来进行实时数据通信的网络协议，主要用来在Flash/AIR平台和支持RTMP协议的流媒体/交互服务器之间进行音视频和数据通信。

* 纯 RTMP: 直接通过 TCP 连接，端口为 1935
* RTMPS: RTMP + TLS/SSL，用于安全性的交流。
* RTMPE: RTMP + encryption。在 RTMP 原始协议上使用，Adobe 自身的加密方法
* RTMPT: RTMP + HTTP。使用 HTTP 的方式来包裹 RTMP 流，这样能直接通过防火墙。不过，延迟性比较大。
* RTMFP: RMPT + UDP。该协议常常用于 P2P 的场景中，针对延时有变态的要求。


##### RTMP的优点
* 延迟小
* 基于 TCP 长连接，不需要多次建连

##### RTMP的缺点
